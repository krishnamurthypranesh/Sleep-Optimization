---
title: "Sleep-Analysis"
author: "Pranesh Krishnamurthy"
date: "10 March 2018"
output: html_document
---

This is the file in which I'll be capturing the analysis and insights about the data, before I test my three hypotheses. 

```{r setup, include=FALSE}
sessionInfo()
```

# Load libraries and data

```{r libraries}

packages <- c("ggplot2", "tidyr", "dplyr", "magrittr", "ggthemes", "lubridate")

lapply(packages, library, character.only = TRUE)
```

```{r data}

sleep <- read.csv("../../Derived/sleep_cleaned.csv", stringsAsFactors = FALSE)
```

```{r data structure1}

str(sleep)
```

# Data Prep

First things first, I'll convert the perception about day in general to an ordinal categorical variable.

```{r prep1} 

# sleep$perception_day_general <- factor(sleep$perception_day_general, levels = c(1, 2, 3, 4, 5), ordered = TRUE)
```

Next, I'll parse the dates, into actual dates and convert the days into ordinal categorical variables

```{r prep2: dates}

# sleep <- sleep %>% 
#   mutate(date_expected_sleep = dmy(date_expected_sleep),
#          date_actual_sleep = dmy(date_actual_sleep),
#          date_wake_up = dmy(date_wake_up))
```


```{r prep3: days}

# sleep <- sleep %>% 
#   mutate(day_expected_sleep = wday(date_expected_sleep,label = TRUE),
#          day_actual_sleep = wday(date_actual_sleep,label = TRUE),
#          day_wake_up = wday(date_wake_up,label = TRUE))
```

This is a bit of a drag and here's why: The hypotheses I want to test depend totally upon the duration of my sleep. So, I need to convert that into a continuous variable. Let's do that

```{r prep4: duration of sleep}

sleep <- sleep %>% 
  separate(duration_sleep, c("hours", "unit1", "minutes", "unit2" ), sep = " ", remove = TRUE, convert = TRUE) %>% 
  mutate(minutes = ifelse(is.na(minutes), 00, minutes),
         total_sleep = hours + (minutes / 60)) %>% 
  select(-c(unit1, unit2, hours, minutes))
```

```{r prep5: distribution of duration}

ggplot(sleep) + aes(total_sleep) + geom_density()
```


The next thing to do is prepare the data to test the one other hypothesis. This time, we need to prepare the time variables. And, this is where it gets a little complicated...

# Chuck this section -->Time: What we all strive for

I recently saw a video that said that we humans are like animals and the closer to sunset we hit the sack, the better we sleep. The video also suggested that if we sleep closer to 22:00 hours, the lesser sleep we need and the more invigorated we feel. I want to check if that's true [for me]. So, I'll be converting the time data and engineering some new variables. 

Here's the strategey:
* convert all the variables in time, to hours passed since 00:00. 
* check if I slept on the same day I was supposed to. If I did, no problem.
* If I did not sleep on the same day, add a new feature in which I capture if I slep on the same day or not.
* Measure the distance of my actual sleep time from 22:00 hours of the day and store it in another variable.

This is a lot of work, so I'll just create a function to do all this. Here's the first part of the function: capturing the information about the day on which I slept

```{r time1: same_day_sleep}

# sleep <- sleep %>% mutate(same_day_sleep =  ifelse(day_expected_sleep == day_actual_sleep, 1, 0))
```

Here's the second part of the entire thing: converting the times to hours since 00:00 of the same day.

```{r time2: functions}

# time_differentiator <- function(df) {
#   # get indices of the time variables
#   indices <- grep("time.*", names(df))
#   
#   # get full names of the time variables
#   names_df_ind <- names(df)[indices]
#   
#   # convert to hours passed by mapping time_1_hours over time vars
#   df_mod <- purrr::map(select(df, indices), time_1_hours) %>% as.data.frame
#   
#   # return the modified data frame
#   df_mod
# }
# 
# time_1_hours <- function(x) {
#   
#   # split the input string
#   time_list <- strsplit(x, ":")
#   
#   # convert split strings to numerics
#   for (i in 1:length(time_list)) {
#     time_list[[i]] <- as.numeric(time_list[[i]])
#   }
#   
#   # call time_2_hours
#   time_2_hours(time_list)
# }
# 
# time_2_hours <- function(x) {
#   
#   # get length of input list
#   n_len <- length(x)
#   
#   # create new numeric vector of length n_len
#   new_time_vec <- vector("numeric", n_len)
#   
#   # convert the time to hours passed
#   for (i in 1:n_len) {
#     
#     new_time_vec[[i]] <- x[[i]][[1]] + (x[[i]][[2]] / 60)
#   }
# 
# # return new_time_vec
#   new_time_vec
# }
```

```{r time3: mods}

# # getting the converted times
# times <- time_differentiator(sleep)
# 
# # replacing the old variables
# times %>% 
#   ggplot() + aes(time_expected_sleep) + geom_density()
#  
# times %>% filter(time_actual_sleep > 1) %>% ggplot() + aes(time_actual_sleep) + geom_density() + geom_density(data = times, aes(time_expected_sleep), col = "orange")
```

```{r}

```



Now, that I have the data in the form I need, I need to find out if perception of the day and duration of sleep are associated. For that, all I need to do is run an ANOVA.

# Hypothesis testing

```{r plot1}

ggplot(sleep) + aes(as.factor(perception_day_general), total_sleep) + geom_boxplot()
```


Now, before I jump up and run an ANOVA, I'll check for validity of assumptions about the data.

```{r assumption1: normality}
set.seed(12345)

ks.test(sleep$total_sleep, rnorm(55, mean(sleep$total_sleep), sd(sleep$total_sleep)))
```

Data is approximately normal. So, the ANOVA can be used. 

The next step is to test for homoscedasticity by running Levene's test. 

```{r assumption2: Homoscedasticity}


```



```{r anova: duration of sleep and perception of day}

duration_aov <- aov(total_sleep ~ perception_day_general, data = sleep)

# summary of the aov
summary(duration_aov)
```

Let's run a Tukey HSD to find out where the differences lie.

```{r anova: TukeyHSD}

# where do the differnces lie?
TukeyHSD(duration_aov)
```

This tells me that there are no within group significant differences in the perception of day. I'll feel the same way irrespective of how much sleep I get. 
Now, this is counter-intuitive. But, this might be true because there are a lot of other things that happen throughout the day and these can affect my perception of the day in wild ways. I enter this data just before I sleep and so there might be other influences in the day. But, it is a good observation. I should collect more data, and this time, I should focus on other factors: for example, how I felt about my work day itself. 

So, does getting more sleep improve the perception of my day? This is quite an interesting question. However, the anova results state that there are no significant differences in sleep times across perceptions of the day. In other words, this means that the amount of sleep and perception of the day are unrelated. Too bad. Nothing to optmize here.  

# End Result

Although this served as a pretty good approximation, there are no statistically significant differences in sleep times across perceptions of the day. This means that I can either sleep more or less and have the same feeling about the day. But, this is obviously not true as sleep affects my mornings, which in turn affect my work day. And, my workday affects how I feel about the rest of the day. 

There are a lot of moderating and mediating factors, and these need to be taken into account before I draw any sort of conclusion. 

That said, I am running another data collection campaign in which I am tracking a whole lot of variables, not just sleep. 

#Peace








------------------------------------------------------------
Now before I decide anything else, I'll run a permutation test to see if the differences hold.

# Permutation Test --> This is chucked because of the other functions that I have to know

```{r}

get_diff <- function(x, y, rule) {
  rule(x) - rule(y)
}
# 
perm_fun <- function(x, n1, n2) {
  n <- n1 + n2
  idx_a <- sample(1:n, n1)
  idx_b <- setdiff(1:n, idx_a)
  mean_diff <- get_diff(x[idx_a], x[idx_b], mean)
  mean_diff
}
# 
# get_sizes <- function(df, y) {
#   n_table <- table(df[[y]])
#   sizes <- vector("numeric", length(n_table))
# 
#   for (i in seq(length(n_table))) {
#     sizes[[i]] <- n_table[[i]]
#   }
#   sizes
# }
# 
# get_combinations <- function(df, y) {
#   lvl <- unique(df[[y]])
#   combinations <- vector("character", 
#                          function() prod(seq(legnth(lvl))) / (prod(2) * prod(seq(length(lvl) - 2))))
#   
#   for (i in lvl) {
#     for (j in lvl) {
#       if (i != j) {
#         combinations[[i]] <- paste(lvl[[i]], lvl[[j]], sep = "-")}
#     }
#   }
#   
#   
# }
# 
perms <- function(x, n1, n2, rep = 1000) {
  
  perm_diffs <- vector("numeric", rep)
  
  for (i in seq(rep)) {
    perm_diffs[[i]] <- perm_fun(x, n1, n2)
  }
  
  perm_diffs
}
```


Instead of creating an entire function that does a whole lot of shit, I'll leverage the power of functionals that R provides. In this case that would be the purrr::map2() function. 

I'll have a list of combinations and the pass them as inputs to purrr::map2() and get the desired outputs.
```{r}

upper <- list(one = 5, two = 5, three = 5, four = 24, five = 24, six = 21)
lower <- list(one = 24, two = 21, three = 5, four = 24, five = 5, six = 5)
```

```{r}
set.seed(1234)

perm_differences <- purrr::map2(upper, lower, perms, x = sleep$total_sleep, rep = 10000)
```


```{r}
# two_and_three <- mean(sleep$total_sleep[sleep$perception_day_general == 2]) - mean(sleep$total_sleep[sleep$perception_day_general == 3])
# as.data.frame(perm_differences) %>% ggplot() + aes(one) + geom_histogram() + geom_vline(xintercept = two_and_three)
```

It works. I'll get the plots for the other differences, save them and then use them in the post.

Since I'm going to have to repeat the entire procedure of plotting the intercepts, I'll write a function to do the job for me.

```{r}
# for (i in 1:length(unique(sleep$perception_day_general))) {
#   for (j in 1:length(unique(sleep$perception_day_general))) {
#     print(get_diff(sleep$total_sleep[sleep$perception_day_general == unique(sleep$perception_day_general)[[i]]], sleep$total_sleep[sleep$perception_day_general == unique(sleep$perception_day_general)[[j]]], rule = mean))
#   }
# }  #print(unique(sleep$perception_day_general)[[i]])
# 
# 
# get_uniques <- function(df, x, y) {
#   uniques <- unique(df[[y]])
#   diffs <- vector("numeric", prod(seq(length(uniques))))
#   
#   for (i in seq(length(uniques))) {
#     for (j in seq(length(uniques))) {
#       diffs[[i]] <- get_diff(df[[x]][df[[y]] == uniques[[i]]], df[[x]][df[[y]]== uniques[[j]]], rule = mean)
#     }
#   }
#   diffs
# }
```

```{r}
# get_uniques(sleep, "total_sleep", "perception_day_general")
```

```{r automating observed difference calculation}

calc_obs_diffs <- function(df, comb1, comb2) {
  get_diff(df[["total_sleep"]][df[["perception_day_general"]] == comb1], df[["total_sleep"]][df[["perception_day_general"]] == comb2], rule = mean)
}
```

Now, I'll run the function to get the values of the permutations. 

```{r}

combinations_upper <- c(2, 2, 2, 3, 3, 4)
combinations_lower <- c(3, 4, 5, 4, 5, 5)

observed_diffs <- purrr::map2_dbl(combinations_upper, combinations_lower, calc_obs_diffs, df = sleep)
names(observed_diffs) <- c("two-three", "two-four", "two-five", "three-four", "three-five", "four-five")

observed_diffs
```


# Cool programming stuff - Totally not needed for the analysis.

Now, I'll automate the procedure of plotting the graphs. I don't want to duplicate the entire code again. 

```{r automating the plotting}

# get_perm_plots <- function(df, obs_diffs) {
#   ggplot(df) + aes(names(df)[, 1]) + geom_histogram()
# }

# get_perm_plots(as.data.frame(perm_differences))

# p <- vector("list", 1)

# # p <- 
# ggplot(sleep) + aes("total_sleep") + geom_histogram()

# plot_list <- purrr::map2(perm_differences, observed_diffs, function(x, y) if (is.numeric(x)) ggplot() + aes(x) + geom_histogram() + geom_abline(xintercept = y))

get_plots <- function(x, obs_diffs) {
  ggplot(as.data.frame(perm_differences)) + aes(x) + geom_histogram(binwidth = 0.1) + geom_vline(xintercept = obs_diffs)
}

purrr::map2(as.data.frame(perm_differences), observed_diffs, get_plots)
```


```{r prepping data for plotting}
names(perm_differences) <- c("two-three", "two-four", "two-five", "three-four", "three-five", "four-five")

perm_differences <- as.data.frame(perm_differences)
```


```{r getting the plots}

get_plots <- function(x, obs_diffs) {
  ggplot(as.data.frame(perm_differences)) + aes(x) + geom_histogram(binwidth = 0.1) + geom_vline(xintercept = obs_diffs) + xlab(names(perm_differences)) + theme_fivethirtyeight()
}

plots_list <- purrr::map2(as.data.frame(perm_differences), observed_diffs, get_plots)
```


Now, I'll write the plots to disk

```{r writing plots to disk}

file_names <- c("diff_2_3.png", "diff_2_4,png", "diff_2_5.png", "diff_3_4.png", "diff_3_5.png", "diff_4_5.png")

purrr::map2(file_names, plots_list, function(fn, pl) 
  {ggsave(filename = fn, path = "../../Derived", plot = pl, units = "mm", width = 200, limitsize = F)})


ggsave(filename = file_names[[1]], path = "../../Derived", plot = plots_list[[1]], units = "mm", width = 200, limitsize = F)
```


# Getting the outputs

Now, as a good statistician would do, I'll print out and then save the plots.

```{r printing out the plots}

# two and three
ggplot(perm_differences) + aes(two.three) + geom_histogram(binwidth = 0.1) + geom_vline(xintercept = observed_diffs[[1]]) + ggtitle("Plot of permuted differences", subtitle = "2 and 3") + theme_fivethirtyeight()

# two and four
ggplot(perm_differences) + aes(two.four) + geom_histogram(binwidth = 0.1) + geom_vline(xintercept = observed_diffs[[2]]) + ggtitle("Plot of permuted differences", subtitle = "2 and 4") + theme_fivethirtyeight()

# two and five
ggplot(perm_differences) + aes(two.five) + geom_histogram(binwidth = 0.1) + geom_vline(xintercept = observed_diffs[[3]]) + ggtitle("Plot of permuted differences", subtitle = "2 and 5") + theme_fivethirtyeight()

# three and four
ggplot(perm_differences) + aes(three.four) + geom_histogram(binwidth = 0.1) + geom_vline(xintercept = observed_diffs[[4]]) + ggtitle("Plot of permuted differences", subtitle = "3 and 4") + theme_fivethirtyeight()

# three and five
ggplot(perm_differences) + aes(three.five) + geom_histogram(binwidth = 0.1) + geom_vline(xintercept = observed_diffs[[5]]) + ggtitle("Plot of permuted differences", subtitle = "3 and 5") + theme_fivethirtyeight()

# four and five
ggplot(perm_differences) + aes(four.five) + geom_histogram(binwidth = 0.1) + geom_vline(xintercept = observed_diffs[[1]]) + ggtitle("Plot of permuted differences", subtitle = "4 and 5") + theme_fivethirtyeight()
```


Saving the plots to disk.

```{r saving the plots}

```

