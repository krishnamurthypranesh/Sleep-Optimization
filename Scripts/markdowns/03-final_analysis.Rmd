---
title: "Final Analysis"
author: "Pranesh Krishnamurthy"
date: "27 March 2018"
output: word_document
---
This is the file in which I'll be capturing the analysis and insights about the data, before I test my three hypotheses. 

```{r setup, include=FALSE}
sessionInfo()
```

# Load libraries and data

```{r libraries}

packages <- c("ggplot2", "tidyr", "dplyr", "magrittr", "ggthemes", "lubridate")

lapply(packages, library, character.only = TRUE)
```

```{r data}

sleep <- read.csv("../../Derived/sleep_cleaned.csv", stringsAsFactors = FALSE)
```

```{r data structure1}

str(sleep)
```

# Data Prep

This is a bit of a drag and here's why: The hypotheses I want to test depend totally upon the duration of my sleep. So, I need to convert that into a continuous variable. Let's do that

```{r prep4: duration of sleep}

sleep <- sleep %>% 
  separate(duration_sleep, c("hours", "unit1", "minutes", "unit2" ), sep = " ", remove = TRUE, convert = TRUE) %>% 
  mutate(minutes = ifelse(is.na(minutes), 00, minutes),
         total_sleep = hours + (minutes / 60)) %>% 
  select(-c(unit1, unit2, hours, minutes))
```


# Data summarization
Before I jump in and test my hypothesis, I'll look for at the data. I'm not going to be looking at a whole lot of stuff. Rather I'll focus only on answering the question at hand: Does more sleep mean better overall perception about the day. 

```{r data summary}

sleep %>% 
  group_by(perception_day_general) %>% 
  summarise(
    mean_sleep_time = mean(total_sleep),
    median_sleep_time = median(total_sleep)
  ) %>% 
  gather(mean_sleep_time:median_sleep_time, key = type, value = sleep_times) %>% 
  ggplot() + aes(perception_day_general, sleep_times) + geom_line(aes(col = type))
```

The plot shows that, for best results (perception_day_general > 3), I need to get 8 to 8.5 hours (not inclusive) of sleep. That's based on the mean. Looking at the median values, I need to get around 8 hours of sleep (Maybe what they say is true). 

But, are these differences statistically significant? This is where the tests come in. 


# Permutation test

I'm using a permutation test for 2 reasons:
1. The data doesn't seem to be normally distributed.
2. The sample size is less [like way too less].

That's why I'm using a permutation test instead of a one-way anova. 

```{r}

# function to get difference based on a particular rule
get_diff <- function(x, y, rule) {
  rule(x) - rule(y)
}

# function to compute permuted differences in means
perm_fun <- function(x, n1, n2) {
  n <- n1 + n2
  idx_a <- sample(1:n, n1)
  idx_b <- setdiff(1:n, idx_a)
  mean_diff <- get_diff(x[idx_a], x[idx_b], mean)
  mean_diff
}

# function to combine the entire thing
perms <- function(x, n1, n2, rep = 1000) {
  
  perm_diffs <- vector("numeric", rep)
  
  for (i in seq(rep)) {
    perm_diffs[[i]] <- perm_fun(x, n1, n2)
  }
  
  perm_diffs
}
```


Instead of creating an entire function that does a whole lot of shit, I'll leverage the power of functionals that R provides. In this case that would be the purrr::map2() function. 

I'll have a list of combinations and the pass them as inputs to purrr::map2() and get the desired outputs.
```{r}

upper <- list(one = 5, two = 5, three = 5, four = 24, five = 24, six = 21)
lower <- list(one = 24, two = 21, three = 5, four = 24, five = 5, six = 5)
```

```{r}
set.seed(1234)

perm_differences <- purrr::map2(upper, lower, perms, x = sleep$total_sleep, rep = 10000)
```

```{r automating observed difference calculation}

calc_obs_diffs <- function(df, comb1, comb2) {
  get_diff(df[["total_sleep"]][df[["perception_day_general"]] == comb1], df[["total_sleep"]][df[["perception_day_general"]] == comb2], rule = mean)
}
```

Now, I'll run the function to get the values of the permutations. 

```{r}

combinations_upper <- c(2, 2, 2, 3, 3, 4)
combinations_lower <- c(3, 4, 5, 4, 5, 5)

observed_diffs <- purrr::map2_dbl(combinations_upper, combinations_lower, calc_obs_diffs, df = sleep)
names(observed_diffs) <- c("two-three", "two-four", "two-five", "three-four", "three-five", "four-five")

observed_diffs
```

# Getting the outputs

Now, as a good statistician would do, I'll print out and then save the plots.

```{r printing out the plots}

# two and three
ggplot(perm_differences) + aes(two.three) + geom_histogram(binwidth = 0.1) + geom_vline(xintercept = observed_diffs[[1]]) + ggtitle("Plot of permuted differences", subtitle = "2 and 3") + theme_fivethirtyeight()

# two and four
ggplot(perm_differences) + aes(two.four) + geom_histogram(binwidth = 0.1) + geom_vline(xintercept = observed_diffs[[2]]) + ggtitle("Plot of permuted differences", subtitle = "2 and 4") + theme_fivethirtyeight()

# two and five
ggplot(perm_differences) + aes(two.five) + geom_histogram(binwidth = 0.1) + geom_vline(xintercept = observed_diffs[[3]]) + ggtitle("Plot of permuted differences", subtitle = "2 and 5") + theme_fivethirtyeight()

# three and four
ggplot(perm_differences) + aes(three.four) + geom_histogram(binwidth = 0.1) + geom_vline(xintercept = observed_diffs[[4]]) + ggtitle("Plot of permuted differences", subtitle = "3 and 4") + theme_fivethirtyeight()

# three and five
ggplot(perm_differences) + aes(three.five) + geom_histogram(binwidth = 0.1) + geom_vline(xintercept = observed_diffs[[5]]) + ggtitle("Plot of permuted differences", subtitle = "3 and 5") + theme_fivethirtyeight()

# four and five
ggplot(perm_differences) + aes(four.five) + geom_histogram(binwidth = 0.1) + geom_vline(xintercept = observed_diffs[[1]]) + ggtitle("Plot of permuted differences", subtitle = "4 and 5") + theme_fivethirtyeight()
```

This tells me that there are no within group significant differences in the perception of day, i.e., I'll feel the same way irrespective of how much sleep I get. This is counter-intuitive. But, it might be true because there are a lot of other things that happen throughout the day and those can affect my perception of the day in wild ways. I entered this data just before I slept and so there might have been other influences on any day. But, it was a good observation. I should collect more data, and this time, I should focus on other factors: for example, how I felt about my work day itself [This variable was present in the original data, but I chucked because of the difference in units].

So, does getting more sleep improve the perception of my day? This is quite an interesting question. However, the results state that there are no significant differences in sleep times across perceptions of the day. In other words, this means that the amount of sleep and perception of the day are unrelated. Too bad. Nothing to optmize here.  

# End Result

Although this served as a pretty good approximation, there are no statistically significant differences in sleep times across perceptions of the day. This means that I can either sleep more or less and have the same feeling about the day. But, this is obviously not true as sleep affects my mornings, which in turn affect my work day. And, my workday affects how I feel about the rest of the day. 

There are a lot of moderating and mediating factors, and these need to be taken into account before I draw any sort of conclusion. Also, this is worth exploring further.

That said, I am running another data collection campaign in which I am tracking a whole lot of variables, not just sleep. 

#Peace